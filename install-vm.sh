#!/bin/sh

# This is the Forward Tunnel Client installation script.
usage() {
   cat<<EOF
--image,            docker image name of the Secure Tunnel Client by default It is cp.icr.io/cp/cp4mcm/secure-tunnel@sha256:33e8bd321ab87da20b514428ee0b2a9ae179aa0934fb9bcd0050041a2f4fe4ef
--accept-license,   If you don't set --accept-license to true, you are asked to accept the license during installation.
--help,             for help

For example:
   ./install-vm.sh --image cp.icr.io/cp/cp4mcm/secure-tunnel@sha256:33e8bd321ab87da20b514428ee0b2a9ae179aa0934fb9bcd0050041a2f4fe4ef --accept-license true
EOF
}


while true ; do
    case "$1" in
        --image) 
            export IMAGE=$2
            if [ "$2" == "" ]; 
            then
                usage
                exit 1
            fi
            shift 2 ;;
        --accept-license) 
            export ACCEPT_LICENSE=$2
            if [ "$2" == "" ]; 
            then
                usage
                exit 1
            fi
            shift 2 ;;
        --help)
            usage
            exit 0 
            ;;
        -h)
            usage
            exit 0 
            ;;
        *)
            if [ "$1" != "" ]; 
            then
                usage
                exit 1
            fi
            break
            ;;
    esac
done



if [ "${IMAGE}" == "" ];
then
    export IMAGE=cp.icr.io/cp/cp4mcm/secure-tunnel@sha256:33e8bd321ab87da20b514428ee0b2a9ae179aa0934fb9bcd0050041a2f4fe4ef
fi

if [ "${ACCEPT_LICENSE}" != "true" ];
then
    echo Do you accept the license agreement\(s\) found in the directory ./licenses?
    echo Please enter [ 1-to accept the agreement, 2-to decline the agreement ] : 
    read accept_license
    if [ "${accept_license}" != "1" ];
    then
        exit 0
    fi
fi

docker stop tunnel-client-b8132330035a4e84
docker rm tunnel-client-b8132330035a4e84
docker run \
-d \
--name tunnel-client-b8132330035a4e84 \
-e REVERSE=false \
-e SERVER=https://sre-tunnel-b8132330035a4e84-kube-system.customer8-cp4mcm-c821d-bf71d5c157aa98b6c96891f5d1f815dc-0000.us-south.containers.appdomain.cloud/sre-tunnel-tunnel/ws \
-e SERVER_CERT_CA=LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVkVENDQTEyZ0F3SUJBZ0lSQUtkaWdaNWpqK1R1NmhVU3FwaEFibTR3RFFZSktvWklodmNOQVFFTEJRQXcKUXpFVk1CTUdBMVVFQ2hNTVkyVnlkQzF0WVc1aFoyVnlNU293S0FZRFZRUURFeUZpT0RFek1qTXpNREF6TldFMApaVGcwTFRNeFlUWXhPR00yTURkalpqUTRZMll3SGhjTk1qSXdOREEzTVRBMU1USTVXaGNOTWpRd05EQTJNVEExCk1USTVXakJETVJVd0V3WURWUVFLRXd4alpYSjBMVzFoYm1GblpYSXhLakFvQmdOVkJBTVRJV0k0TVRNeU16TXcKTURNMVlUUmxPRFF0TXpGaE5qRTRZell3TjJObU5EaGpaakNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUApBRENDQVFvQ2dnRUJBTGZQN3NnQVp5Wmt5MmxnTVRZS2R2b092NXBjWDM2OFVacmx6dHNvbWJEbWJuV2hjOVh1ClRNVG10b081NDJGcU82Ly9CRGQyOTNUWW5VTGQ5RHo1eUVyNjVhdTBvWGFXWENUcTQzNWExWUJ6VVJ2Q3FDalcKa3ZSc1pPaWhmdGdTQ0g5aVVGaERiei9HL2c0QVdOdVFWd2R2ODZzUjZ4WUtUdGRQakhVekk0YTlrQjdiWmRxcwpOVnF3RGY3SDRSdXRDV0ZyU0xFVm96V2JQMWZsMU9OTVZYeGNYZU52T1hwSlNlU2o2eXlwakxTR0Vhd21CamNHCitiNzdLSjFvWnFtY3ZyMXphSUZGK0N2b0E1VDhpT3R1SGh2QmN3eGlYSnlMTmxldWNYSGh3OGdrVmtPM29FS0oKNjFKZkhwT3F4NEVVUUJ0S0l1K2d0MFcrbUtUVkZzZGxyL2tDQXdFQUFhT0NBV0l3Z2dGZU1BNEdBMVVkRHdFQgovd1FFQXdJQ3BEQVBCZ05WSFJNQkFmOEVCVEFEQVFIL01CMEdBMVVkRGdRV0JCU0grTlhaQlZmQ1hIQm9JTUd0ClNBeTFxRDNSeVRDQ0FSb0dBMVVkRVFTQ0FSRXdnZ0VOZ2lGaU9ERXpNak16TURBek5XRTBaVGcwTFRNeFlUWXgKT0dNMk1EZGpaalE0WTJhQ0NXeHZZMkZzYUc5emRJSWZjM0psTFhSMWJtNWxiQzFpT0RFek1qTXpNREF6TldFMApaVGcwTFhOMlk0SXJjM0psTFhSMWJtNWxiQzFpT0RFek1qTXpNREF6TldFMFpUZzBMWE4yWXk1cmRXSmxMWE41CmMzUmxiWUtCaUhOeVpTMTBkVzV1Wld3dFlqZ3hNekl6TXpBd016VmhOR1U0TkMxcmRXSmxMWE41YzNSbGJTNWoKZFhOMGIyMWxjamd0WTNBMGJXTnRMV000TWpGa0xXSm1OekZrTldNeE5UZGhZVGs0WWpaak9UWTRPVEZtTldReApaamd4TldSakxUQXdNREF1ZFhNdGMyOTFkR2d1WTI5dWRHRnBibVZ5Y3k1aGNIQmtiMjFoYVc0dVkyeHZkV1NICkJIOEFBQUV3RFFZSktvWklodmNOQVFFTEJRQURnZ0VCQUFoV2IwRTE4Q0QrOUtlWjVQM05VMTVtekpDYVpVSmQKWUlhU1VacytSWFZmU0E3UXp4L2dINDRFNCtXczYxWVl5MHBhbVp2bHVSeFM5aDhLdW5qcUlIU09PYTVyNHVCbwp4RGpRMGN0QlpqdWdSN1AyRkp4QXhENVhHQ0wwdVdBMHB6T0dIUHpwT0ExYUxPZzlYZ0NVL0xQYWRZQmhBL0RLClZlNkNvTTZJOWJWbmR3emFRVDdzUFNyMTZpL0xpcnNrYkpZeVJKd1NGSmVEOTY5QnJuY0tXUlB0NUFZV3dHSjYKVnRpY2d0aGFvUjVWeGx2U1BKSFhFZ0VVVmxUamc4RXJRRE4yRURvL3pNYUFVR0J6YmVYUCtOd2RrdmpvTjJINQpOckNqdXBjN2o2R1NuRmFqUVVEM0FwQmtmZTdGaGdIelkwYkZIWUxKVUVobXZ6MDVkeVJ2NTBFPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== \
-e CLIENT_CERT_CRT=LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURnVENDQW1tZ0F3SUJBZ0lSQUwxcnpzbDh4VXUzMWFaTVdhQXFGcW93RFFZSktvWklodmNOQVFFTEJRQXcKUXpFVk1CTUdBMVVFQ2hNTVkyVnlkQzF0WVc1aFoyVnlNU293S0FZRFZRUURFeUZpT0RFek1qTXpNREF6TldFMApaVGcwTFRNeFlUWXhPR00yTURkalpqUTRZMll3SGhjTk1qSXdOREEzTVRBMU1UTXdXaGNOTWpRd05EQTJNVEExCk1UTXdXakJETVJVd0V3WURWUVFLRXd4alpYSjBMVzFoYm1GblpYSXhLakFvQmdOVkJBTVRJV0k0TVRNeU16TXcKTURNMVlUUmxPRFF0TXpGaE5qRTRZell3TjJObU5EaGpaakNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUApBRENDQVFvQ2dnRUJBTXJYQU9YbWY0TmVyQTR4cXR4NUJZU1BEUUxvR0Q2K2FyUDY0Y3E3YlRFeklNZEphZENzClV1N0ZKYXJQQitybWZWMkUvRGxRSWxOVllLaGxycVBUM2tVeGVOclArNE0wNmQzS1o1MnN3VUhEQ1psWVFWd1UKSzZJNnhZZ1B3ZDZWaGZ1cnczU1I1MjI4MnBZQ25RSC9RNVprVFpKQjRWTlRiR2cwTENxem8zSXBiWDhFZ3MzNQpsb285TlkrcHNGakRUTmpHQnNJVGV0NVZWNTRHLzhQNDgwWklZR1Mvb3E5TnZ6Mkx4UE1TVDJOb3hhWk5OVE5ZCkp6UFJkWk43T1RNaWw3QXpzSnJIek5ldGswdTNpMkFFVUJzZHpsNmNYUkV1ck1xaExsMlowNnpRaEFPUm9UN2UKU2hRZmE2bkoyOEV5a3daR2p0T1NlbFFvRHBXNnN4MHhSWTBDQXdFQUFhTndNRzR3RGdZRFZSMFBBUUgvQkFRRApBZ0trTUE4R0ExVWRFd0VCL3dRRk1BTUJBZjh3SFFZRFZSME9CQllFRklpY0FYWG5RRHZyaTY1R0hYSjJTbW54CjdkRkJNQ3dHQTFVZEVRUWxNQ09DSVdJNE1UTXlNek13TURNMVlUUmxPRFF0TXpGaE5qRTRZell3TjJObU5EaGoKWmpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQWVNMTNzNm5Dekh4RThZUFpiZnhmaWJqbFozS0hqWXF6NDRhUwpPRm5KNUw2R1Q4TnN6bWhoTVpiWTc4TWgrU3pCY3U0M0lGOG5oZm5McE1aVnY0OWVrTmVxQXA1NHNHTDV1ZVlMCjFuY2cwRGFjb3ZsOU5XanJrNGhMajVwaDRGa0NxMTVNdm1XVzJaejlzZStjZGdnNmp1MVhISHNTYUZRZ0FJSWoKZVNiWXp3US9vY05BRXlZVXRvTktZLy8rM1lMR1lZNHNVR2UybUl0VHdDOFp4L2NpdVVMNUFTQnU1bWFuN1l6SgpOZEgrREdGN0JUZkl6aW5DT1U1VnRFTTROQXg3aEpQVDh3UWl2LzdjcFVFZ1l3SlRFclF4RzZXUXhDdk5kcjd2ClVPaURYcVBaRkFxREpKaUxjSDhpOC9xOS9Sb0s0RDlzTURHaE1ScGJVRGZDSUN4emp3PT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo= \
-e CLIENT_CERT_KEY=LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBeXRjQTVlWi9nMTZzRGpHcTNIa0ZoSThOQXVnWVByNXFzL3JoeXJ0dE1UTWd4MGxwCjBLeFM3c1VscXM4SDZ1WjlYWVQ4T1ZBaVUxVmdxR1d1bzlQZVJURjQycy83Z3pUcDNjcG5uYXpCUWNNSm1WaEIKWEJRcm9qckZpQS9CM3BXRis2dkRkSkhuYmJ6YWxnS2RBZjlEbG1STmtrSGhVMU5zYURRc0tyT2pjaWx0ZndTQwp6Zm1XaWowMWo2bXdXTU5NMk1ZR3doTjYzbFZYbmdiL3cvanpSa2hnWkwraXIwMi9QWXZFOHhKUFkyakZwazAxCk0xZ25NOUYxazNzNU15S1hzRE93bXNmTTE2MlRTN2VMWUFSUUd4M09YcHhkRVM2c3lxRXVYWm5Uck5DRUE1R2gKUHQ1S0ZCOXJxY25id1RLVEJrYU8wNUo2VkNnT2xicXpIVEZGalFJREFRQUJBb0lCQVFDR2E3dHRuN1hyTWtjbApWT2JkR3RwOFFXeW0rM1p0eGpUaU55V0ErM3BlTzNyQ2RyVklFNXNXSHRKYWdyN0ZmWitnNVN0ZE0reTdldjRHCk92UmtIMWpTVS9tNlVGQm1ZQitIMnNXVjZWRmRLa3BuTStTRWg5MXVzaklMZkIzSFN5R3lhZDZxbHJKZXQrUEgKdTgyZThESXpMUjkzQ0creGo3eHN4ZjVyQWdjVDlKQk94QVh3VDh3NEttRkwzQmZHeEZ4SjZIUkVSYXdyOERkcApIb1JBUDk2SmdKL1ZoRWtVNk9vTTNjdmpJeHpSRGdJUzR6cE5hMlU0MVhZOXVsZTJUcVRWZ2JvUXRlL3d2d1dtCkJRNjE1ZjlXNzlxMXI0dFp2ZzZFTldjd0lrbVlGL3VsZkVaYm9uUEFHNkNDQUlmUlZMbkdUUmw0MHJVWVozTSsKOUtFMDlmMmxBb0dCQU9GU25sczBrQlViTTRtNGhRajVWMDlmY3YzS0wzY2ZtZjNBTldyRFNtTTJvSFlGWlJiRApvTHY1WTZqNk92RHdPVWJnTWpWMXBZTjZZR2txaXkxZEpCck5SamgrOUgvWVQrZnAwRzZyaFZpdTRVbjBGOUNVCmxwMDQ1REhTREU2UEJab3o0anZyOGcvdU50VXRzNlFpUmt0NUJJbkZBRk5ncEZ2MjRlTURXT2tMQW9HQkFPWjAKeE1SK242U0JkRXJldnFLekJYcnNTbGI1L1V5TWxmajQ1R0lOZzJlM3QxL2pjTlh2ZnRTUGJGc3RtNmNwa0w4TQpEWGhmUStwTCtQZVlmQU1oeHNGZzZVOXNSQy9HWVFWanlPcXE3bG9KWDg4a1p2ejB5TkZkTWlvOFE2dXAzcXhECjF6NHZncUhvOE1KK21uMGo1MHJPS3ZmVERkUS9BeisyYUZpOTJ4ckhBb0dBQ09UMUFVNnEzVnBzaDJRMFJDMXIKaCtPUnEzait0S29YcncrV1REZVhTU0ZQNWpqQ1M4cS9Ib3h5cGFuekI2M0Q1UXRXa0F1cjArdlJ3SFVBZDNMMAp5T1lQZm8xc1kxdUxrL0VEM0VxREFnUXRPbmtiTTQyYUFHek5mVFg0YkdWeTZDcGlKTkZraGNKMmdhWERNSmgxCncrYnNDZkF2MmhxM2dqWFZwdHRyK0E4Q2dZRUFrbVIwcGhtRmtidUdReFV4NWlwd2ZjQmlETlFxdXBqSG4rdUQKTUdKREtmeURLUTlTbXlQUzNuWHBNQlpOdlNkalFta0dtWU55b2YvMnZGbUoxWGQ4U1ZVbGdBVlhYejNXWGRVZwpTU21oMVdJRkVaR2ZObXJNc21wUU5wSW5yb0Z1Nk9FRGR3WTVKbDdScWN0QW1lUFh4aVluRjF4amVZTTVyaHhTCk5xVUw3UHNDZ1lCZEQyZGZaemVuY3FmdEVlK2d0RUdZcjRPZkJsRi9NclhhZm0rcDU3Ni9mRFhRYmdqQlhnN1UKcGRlaHk3M0kvZ1FiV1lrU3hDY3E4dW9iKzdxZExLUERTZVJHdHhmdXMxU2hMK0E2dFJNb2xGNmJPRDBzSnVtZgp0aGpjbFJXYlJCeTNwY2tIcW5pYldoOWF2TlpRNE1SdDRNenBLeFJLQXlQbXBUOTRBUFF1Q0E9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo= \
--restart="always" \
--read-only \
--user 1001:1001 \
${IMAGE} \
/etc/tunnel/tunnel-client
RET=$?
if [ "${RET}" != "0" ];
then
    echo "FAIL: Failed to install Tunnel Client."
    exit ${RET}
fi

echo "Install Tunnel Client successful."